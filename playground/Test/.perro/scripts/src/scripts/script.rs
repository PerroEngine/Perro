use perro_api::prelude::*;
use perro_core::prelude::*;
use perro_ids::prelude::*;
use perro_scripting::prelude::*;

///@State
#[derive(Default)]
pub struct ExampleState {
    speed: f32,
}

///@Script
pub struct ExampleScript;

impl<R: RuntimeAPI + ?Sized> ScriptLifecycle<R> for ExampleScript {
    fn init(&self, api: &mut API<'_, R>, self_id: NodeID) {
        let _origin = Vector2::new(0.0, 0.0);
        let _ = api
            .Scripts()
            .with_state_mut::<ExampleState, _, _>(self_id, |state| {
                state.speed = 240.0;
            });
    }

    fn update(&self, api: &mut API<'_, R>, self_id: NodeID) {
        let dt = api.Time().get_delta();
        let _ = api
            .Scripts()
            .with_state_mut::<ExampleState, _, _>(self_id, |state| {
                state.speed += dt;
            });
    }

    fn fixed_update(&self, _api: &mut API<'_, R>, _self_id: NodeID) {}
}


// ---- AUTO-GENERATED by perro_compiler ----
const __PERRO_VAR_SPEED: ScriptMemberID = ScriptMemberID::from_string("speed");


impl<R: RuntimeAPI + ?Sized> ScriptBehavior<R> for ExampleScript {
    fn script_flags(&self) -> ScriptFlags {
        ScriptFlags::new(ScriptFlags::NONE | ScriptFlags::HAS_INIT | ScriptFlags::HAS_UPDATE | ScriptFlags::HAS_FIXED_UPDATE)
    }

    fn get_var(&self, state: &dyn std::any::Any, var_id: ScriptMemberID) -> Variant {
        let Some(state) = state.downcast_ref::<ExampleState>() else {
            return Variant::Null;
        };
        if var_id == __PERRO_VAR_SPEED {
            return Variant::from(state.speed);
        }
        Variant::Null
    }

    fn set_var(&self, state: &mut dyn std::any::Any, var_id: ScriptMemberID, value: Variant) {
        let Some(state) = state.downcast_mut::<ExampleState>() else {
            return;
        };
        if var_id == __PERRO_VAR_SPEED {
            if let Some(v) = value.as_f32() {
                state.speed = v;
            }
            return;
        }

    }

    fn apply_exposed_vars(&self, state: &mut dyn std::any::Any, vars: &[(ScriptMemberID, Variant)]) {
        for (var_id, value) in vars {
            <Self as ScriptBehavior<R>>::set_var(self, state, *var_id, value.clone());
        }
    }

    fn call_method(
        &self,
        _method_id: ScriptMemberID,
        _api: &mut API<'_, R>,
        _self_id: NodeID,
        _params: &[Variant],
    ) -> Variant {
        Variant::Null
    }

    fn attributes_of(&self, member: &str) -> Vec<String> {
        match member {
            "speed" => vec!["export".to_string()],
            _ => Vec::new(),
        }
    }

    fn members_with(&self, attribute: &str) -> Vec<String> {
        if attribute == "export" {
            return vec![
                "speed".to_string(),
            ];
        }
        Vec::new()
    }

    fn has_attribute(&self, member: &str, attribute: &str) -> bool {
        if attribute != "export" {
            return false;
        }
        matches!(member, "speed")
    }
}
